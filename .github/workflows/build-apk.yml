name: Build Android APK (Debug Manifest)

on:
  push:
    branches: [ "main" ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    env:
      APP_VERSION_NAME: "1.2"
      APP_VERSION_CODE: 3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Organize Web Files
      run: |
        mkdir -p www
        mv *.html www/
        mv js www/
        mv ghani.png www/

    - name: Create package.json
      run: npm init -y

    - name: Install Dependencies
      run: |
        npm install @capacitor/core@5 @capacitor/cli@5 @capacitor/android@5 @capacitor/app@5 @capacitor/local-notifications@5 @capacitor/device@5
        npm install @capacitor/assets --save-dev

    - name: Create Capacitor Config
      run: |
        echo '{
          "appId": "com.mystore.app",
          "appName": "Ghani",
          "webDir": "www",
          "bundledWebRuntime": false,
          "plugins": {
            "LocalNotifications": {
              "smallIcon": "ic_launcher",
              "iconColor": "#10b981",
              "sound": "beep.wav"
            }
          }
        }' > capacitor.config.json

    - name: Add Android Platform
      run: npx cap add android

    - name: Set App Version
      run: |
        sed -i 's/versionName "1.0"/versionName "'"$APP_VERSION_NAME"'"/' android/app/build.gradle
        sed -i 's/versionCode 1/versionCode '"$APP_VERSION_CODE"'/' android/app/build.gradle

    - name: Set Custom App Name
      run: |
        mkdir -p android/app/src/main/res/values
        echo '<resources>
          <string name="app_name">Ghani</string>
          <string name="title_activity_main">Ghani</string>
          <string name="package_name">com.mystore.app</string>
          <string name="custom_url_scheme">com.mystore.app</string>
        </resources>' > android/app/src/main/res/values/strings.xml

    # --- CRITICAL SECTION STARTS ---

    - name: Generate App Icons & Sync
      run: |
        mkdir -p assets
        cp home-screen.png assets/icon.png
        cp home-screen.png assets/splash.png
        npx capacitor-assets generate --android
        npx cap sync android

    # INJECT PERMISSIONS (Forcefully)
    - name: Inject Android Permissions
      run: |
        # Insert Permissions before <application>
        sed -i '/<application/i \    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" \/>\n    <uses-permission android:name="android.permission.VIBRATE" \/>\n    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" \/>\n    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" \/>\n    <uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" \/>\n    <uses-permission android:name="android.permission.WAKE_LOCK" \/>' android/app/src/main/AndroidManifest.xml
        
        # Explicitly Inject Receiver inside <application> tag (Just in case)
        sed -i '/<activity/i \        <receiver android:name="com.capacitorjs.plugins.localnotifications.LocalNotificationReceiver" android:exported="true" />' android/app/src/main/AndroidManifest.xml

    # DEBUG STEP: PRINT MANIFEST TO LOGS
    - name: üîç VERIFY MANIFEST CONTENT
      run: cat android/app/src/main/AndroidManifest.xml

    # --- CRITICAL SECTION ENDS ---

    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Rename APK
      run: |
        mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/Ghani-Fixed.apk

    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Ghani-Fixed.apk
        path: android/app/build/outputs/apk/debug/Ghani-Fixed.apk
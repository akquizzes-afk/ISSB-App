name: Build Android APK

on:
  push:
    branches: [ "main" ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    env:
      APP_VERSION_NAME: "1.3"
      APP_VERSION_CODE: 4

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Organize Web Files
      run: |
        mkdir -p www
        mv *.html www/
        mv js www/
        mv ghani.png www/

    - name: Create package.json
      run: npm init -y

    - name: Install Dependencies
      run: |
        # Removed @capacitor/local-notifications
        npm install @capacitor/core@5 @capacitor/cli@5 @capacitor/android@5 @capacitor/app@5 @capacitor/device@5
        npm install @capacitor/assets --save-dev

    - name: Create Capacitor Config
      run: |
        # Removed LocalNotifications config
        echo '{
          "appId": "com.mystore.app",
          "appName": "Ghani",
          "webDir": "www",
          "bundledWebRuntime": false
        }' > capacitor.config.json

    - name: Add Android Platform
      run: npx cap add android

    - name: Set App Version
      run: |
        sed -i 's/versionName "1.0"/versionName "'"$APP_VERSION_NAME"'"/' android/app/build.gradle
        sed -i 's/versionCode 1/versionCode '"$APP_VERSION_CODE"'/' android/app/build.gradle

    - name: Set Custom App Name
      run: |
        mkdir -p android/app/src/main/res/values
        echo '<resources>
          <string name="app_name">Ghani</string>
          <string name="title_activity_main">Ghani</string>
          <string name="package_name">com.mystore.app</string>
          <string name="custom_url_scheme">com.mystore.app</string>
        </resources>' > android/app/src/main/res/values/strings.xml

    - name: Generate App Icons & Sync
      run: |
        mkdir -p assets
        cp home-screen.png assets/icon.png
        cp home-screen.png assets/splash.png
        npx capacitor-assets generate --android
        npx cap sync android
        
    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Rename APK
      run: |
        mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/Ghani.apk

    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Ghani.apk
        path: android/app/build/outputs/apk/debug/Ghani.apk
name: Build Android APK (Custom Icon)

on:
  push:
    branches: [ "main" ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    # Define version numbers here
    env:
      APP_VERSION_NAME: "1.1"  # Your public-facing version
      APP_VERSION_CODE: 2       # Must be an integer, and must increase with each new version

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Show What Files The Build Sees
      run: ls -R

    - name: Organize Web Files
      run: |
        mkdir -p www
        mv *.html www/
        mv js www/
        mv ghani.png www/

    - name: Create package.json
      run: npm init -y

    - name: Install Dependencies
      run: |
        npm install @capacitor/core@5 @capacitor/cli@5 @capacitor/android@5 @capacitor/app@5 @capacitor/local-notifications@5
        npm install @capacitor/assets --save-dev

    - name: Create Capacitor Config
      run: |
        echo '{
          "appId": "com.mystore.app",
          "appName": "Ghani",
          "webDir": "www",
          "bundledWebRuntime": false
        }' > capacitor.config.json

    - name: Add Android Platform
      run: npx cap add android

    # --- SET APP VERSION ---
    - name: Set App Version
      run: |
        echo "Setting app version to $APP_VERSION_NAME ($APP_VERSION_CODE)"
        sed -i 's/versionName "1.0"/versionName "'"$APP_VERSION_NAME"'"/' android/app/build.gradle
        sed -i 's/versionCode 1/versionCode '"$APP_VERSION_CODE"'/' android/app/build.gradle

    # --- ENHANCED NOTIFICATION PERMISSIONS ---
    - name: Add Notification Permissions
      run: |
        sed -i '/<application/i \    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" \/>\n    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" android:maxSdkVersion="32" \/>\n    <uses-permission android:name="android.permission.USE_EXACT_ALARM" \/>\n    <uses-permission android:name="android.permission.WAKE_LOCK" \/>' android/app/src/main/AndroidManifest.xml

    - name: Set Custom App Name
      run: |
        mkdir -p android/app/src/main/res/values
        echo '<resources>
          <string name="app_name">Ghani</string>
          <string name="title_activity_main">Ghani</string>
          <string name="package_name">com.mystore.app</string>
          <string name="custom_url_scheme">com.mystore.app</string>
        </resources>' > android/app/src/main/res/values/strings.xml

    - name: Generate App Icons
      run: |
        mkdir -p assets
        # Use ghani.png from www folder since we moved it there
        cp www/ghani.png assets/icon.png
        cp www/ghani.png assets/splash.png
        npx capacitor-assets generate --android
        npx cap sync android

    - name: Build Debug APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Rename APK
      run: |
        mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/Ghani.apk

    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Ghani.apk
        path: android/app/build/outputs/apk/debug/Ghani.apk